<!DOCTYPE html>
<html>
  <head>
    <title>AnyWeather</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 70%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 3%;
      }
    </style>
  </head>
  <body bgcolor="ffe401">
    <img src="media/Logo.png" width="100%">  
    <div id="map" style="width: 100%; height: 50%;"></div> 
    <div align="center"><h3>Our pick for you!</h3>
    <p id="change">Somewhere suitable and local just for you
        </p></div>   
      
    <!--  load JS at the end of the body  -->
    <script src="//maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script> 
    <script src="//www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
    <script src="js/jquery-3.2.1.min.js"></script>  
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false&libraries=geometry"></script>

     
    <script src="firebase.js"></script> 
    <script type="text/javascript"> 
     var myStyle = [
       {
         featureType: "administrative",
         elementType: "labels",
         stylers: [
           { visibility: "off" }
         ]
       },{
         featureType: "poi",
         elementType: "labels",
         stylers: [
           { visibility: "off" }
         ]
       },{
         featureType: "water",
         elementType: "labels",
         stylers: [
           { visibility: "off" }
         ]
       },{
         featureType: "road",
         elementType: "labels",
         stylers: [
           { visibility: "on" }
         ]
       }
     ];
    
     var image = 'media/person.png';
     function initMap() {
     var map = new google.maps.Map(document.getElementById('map'), {
       mapTypeControlOptions: {
         mapTypeIds: ['mystyle', google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.TERRAIN]
       },
       center: new google.maps.LatLng(30, 0),
       zoom: 14,
       mapTypeId: 'mystyle'
     });

     map.mapTypes.set('mystyle', new google.maps.StyledMapType(myStyle, { name: 'My Style' }));
    //adding your location with a peg
     var infoWindow = new google.maps.InfoWindow;
     // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            console.log(pos);
            var marker = new google.maps.Marker({
            position: pos,
            icon: image,
            map: map,
            title: 'You are here!'
            });
         
            map.setCenter(pos);
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
        
      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
      }
       // trial
    navigator.geolocation.watchPosition(gotPosition)

var APIKey = 'a120aa36dac8f8043805f63a51019310'

function gotPosition(position) 
{   
    getTheWeather(position)
}

function getTheWeather(position)
{
    var URL = 'http://api.openweathermap.org/data/2.5/weather?lat=' + position.coords.latitude + '&lon=' + position.coords.longitude + '&APPID=' + APIKey
    console.log(URL)

    $.ajax(
    {
        dataType: "jsonp",
        url: URL,
        success: handleData
    })
}

var currentWeather;



function handleData(json)
{
    console.log(json)

    var weather = json.weather[0]
        
    var weatherid = parseInt(weather.id)
    //    new Number(weatherid)  
    console.log(weatherid)
    currentWeather = weatherid
switch(currentWeather) {
        case 200:
        case 201:
        case 202:
        case 210:
        case 211:
        case 212:
        case 221:
        case 230:
        case 231:
        case 232:
        case 711:
        case 731:
        case 771:
        case 751:
        case 761:
        case 762:
        case 771:
        case 781:
        case 900:
        case 901:
        case 902:
        case 957:
        case 958:
        case 959:
        case 960:
        case 961:
        case 962:
            console.log ("Stormy");
            currentWeather = 'storm' 
            break;
        case 301:
        case 302:
        case 310:
        case 311:
        case 312:
        case 313:
        case 314:
        case 321:
        case 500:
        case 501:
        case 502:
        case 503:
        case 504:
        case 511:
        case 520:
        case 522:
        case 531:
        case 701:
        case 906:
            console.log ("Raining");
            currentWeather = 'rain' 
            break;
        case 600:
        case 601:
        case 602:
        case 611:
        case 612:
        case 615:
        case 616:
        case 620:
        case 621:
        case 622:
            console.log ("Snowy");
            currentWeather = 'snow' 
            break;
        case 800:
        case 801:
        case 951:
        case 952:
        case 953:
        case 954:
        case 955:
        case 956:
        case 721:
            console.log ("Sunny");
            currentWeather = 'sun';
            console.log(currentWeather)
            break;
        case 300:
        case 741:
        case 802:
        case 803:
        case 804:
        case 521:
            console.log ("Cloudy");
            currentWeather = 'cloud'
            break;
        case 904:
            console.log ("Hot day");
            currentWeather = 'hot_day'
            break;
        case 903:
        case 905:
            console.log ("Cold day");
            currentWeather = 'cold_day'
            
}

console.log(currentWeather)


         
         
         
         
         
         
        // adding places with pegs here
    window.addEventListener('locationsLoaded', function(e)
    {
        console.log('locations loaded oh yeah');
        for (var i=0; i<locations.length; i++)
        {
            var location = locations[i];
            console.log(location.places) // name
            addInfoWindow(location);
        }
    }, false);  
        
    function addInfoWindow(location)
    {
        var contentString = '<h1>'+location.places+'</h1>' + '<br>' +
            location.about + '<br>' +
            '<img src="' + location.image +'"width=100%>'
        

        var infowindow = new google.maps.InfoWindow({
          content: contentString
        });
        var pos = 
        {
            lat: location.latitude,
            lng: location.longitude
        };
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var p1 = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            var p2 = new google.maps.LatLng(location.latitude, location.longitude);
            if (calcDistance(p1,p2)>10){
            console.log(location.places)
            var start = p1
            var end = p2
            var DirectionsURL = 'https://www.google.com/maps/dir/?api=1&origin=' + start + '&destination=' + end 
        console.log(DirectionsURL)
            document.getElementById ("change").innerHTML = "Positioned only " + calcDistance(p1,p2)+ " km away "+ '<br>' +location.places +" - "+ location.about +'<br>'+  '<img src="' + location.image +'"width=50%>' +'<br>' +'<a href="' + DirectionsURL +'"role=button>'+'<button>'+ "Get Directions" +'</button>'+'</a>'                
            }
              //calculates distance between two points in km's
            function calcDistance(p1, p2) {
              return (google.maps.geometry.spherical.computeDistanceBetween(p1, p2) / 1000).toFixed(1);
            }})
        var marker = new google.maps.Marker({
            position: pos,
            map: map,
            title: location.places
            });
        
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        })}}}}
    </script>
      <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0IgedE0gQrk_Jb2oUT0dJI9bvt0a9lKQ&callback=initMap">
    </script>
</body> 
</html>